(()=>{var e={};e.id=678,e.ids=[678],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},6226:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},6224:e=>{"use strict";e.exports=require("tty")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},6497:(e,r,t)=>{"use strict";t.r(r),t.d(r,{GlobalError:()=>o.a,__next_app__:()=>x,originalPathname:()=>h,pages:()=>c,routeModule:()=>u,tree:()=>d});var a=t(482),s=t(9108),n=t(2563),o=t.n(n),i=t(8300),l={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(l[e]=()=>i[e]);t.d(r,l);let d=["",{children:["books",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(t.bind(t,391)),"E:\\project\\reading\\reading-app\\app\\books\\[id]\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(t.bind(t,9733)),"E:\\project\\reading\\reading-app\\app\\books\\layout.tsx"]}]},{layout:[()=>Promise.resolve().then(t.bind(t,8062)),"E:\\project\\reading\\reading-app\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(t.t.bind(t,9361,23)),"next/dist/client/components/not-found-error"]}],c=["E:\\project\\reading\\reading-app\\app\\books\\[id]\\page.tsx"],h="/books/[id]/page",x={require:t,loadChunk:()=>Promise.resolve()},u=new a.AppPageRouteModule({definition:{kind:s.x.APP_PAGE,page:"/books/[id]/page",pathname:"/books/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},9528:(e,r,t)=>{Promise.resolve().then(t.bind(t,7567))},7584:(e,r,t)=>{Promise.resolve().then(t.bind(t,6017))},7567:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>k});var a=t(5344),s=t(3729),n=t(165),o=t(8428),i=t(1453),l=t(8117),d=t(3511);function c({onBack:e,onOpenChapterList:r,onOpenSettings:t,onToggleAI:n,title:o}){let l=(0,i.M)(e=>e.isToolbarVisible),c=(0,i.M)(e=>e.settings.theme),h=(0,i.M)(e=>e.updateSettings),x=(0,s.useCallback)(()=>{h({theme:"light"===c?"dark":"light"})},[c,h]);return a.jsx("div",{className:l?"toolbar":"toolbar toolbar-hidden",children:(0,a.jsxs)("div",{className:"flex items-center justify-between px-4 py-2",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[a.jsx(d.Z,{variant:"ghost",size:"sm",onClick:e,children:a.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),a.jsx("div",{className:"text-sm font-medium hidden md:block",children:a.jsx("div",{className:"truncate max-w-md",children:o})})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[a.jsx(d.Z,{variant:"ghost",size:"sm",onClick:r,title:"目录",children:a.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h16"})})}),a.jsx(d.Z,{variant:"ghost",size:"sm",onClick:n,title:"AI 转写",children:a.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})})}),a.jsx(d.Z,{variant:"ghost",size:"sm",onClick:t,title:"设置",children:(0,a.jsxs)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}),a.jsx(d.Z,{variant:"ghost",size:"sm",onClick:x,title:"light"===c?"夜间模式":"日间模式",children:"light"===c?a.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})}):a.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"})})})]})]})})}function h({chapters:e,currentChapterId:r,onChapterSelect:t,onClose:n}){let o=(0,i.M)(e=>e.isChapterListVisible),l=(0,i.M)(e=>e.setChapterListVisible),d=(0,i.M)(e=>e.setToolbarVisible),[c,h]=(0,s.useState)(""),x=(0,s.useRef)(null);(0,s.useEffect)(()=>{o&&d(!1)},[o,d]);let u=[...e].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}).filter(e=>e.chapterName.toLowerCase().includes(c.toLowerCase()));(0,s.useEffect)(()=>{if(o&&r&&x.current){let e=document.getElementById(`chapter-${r}`);e&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"center"})},100)}},[o,r]);let m=(0,s.useCallback)(e=>{if(console.log("章节列表中点击章节:",e,"当前章节:",r),e===r){console.log("点击了当前章节，关闭目录"),n();return}console.log("选择新章节:",e),t(e),setTimeout(()=>{n()},200)},[r,t,n]),p=()=>{l(!1),n()};return a.jsx("div",{className:`chapter-list fixed inset-0 z-40 bg-black bg-opacity-50 transition-opacity ${o?"opacity-100":"opacity-0 pointer-events-none"}`,onClick:e=>{e.target===e.currentTarget&&p()},children:a.jsx("div",{className:`absolute right-0 top-0 bottom-0 w-80 bg-white dark:bg-[#1a1a1a] shadow-xl transition-transform ${o?"translate-x-0":"translate-x-full"}`,children:(0,a.jsxs)("div",{className:"flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center",children:[a.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:"目录"}),a.jsx("button",{onClick:p,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:a.jsx("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),a.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800",children:(0,a.jsxs)("div",{className:"relative",children:[a.jsx("input",{type:"text",placeholder:"搜索章节...",value:c,onChange:e=>h(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-[#252525] dark:text-white"}),a.jsx("svg",{className:"absolute left-3 top-2.5 w-5 h-5 text-gray-400 dark:text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),a.jsx("div",{className:"flex-1 overflow-y-auto scrollbar-hide",ref:x,children:0===u.length?a.jsx("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:c?"没有找到匹配的章节":"没有章节"}):a.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-800",children:u.map(e=>a.jsx("li",{id:`chapter-${e.chapterId}`,className:`p-4 hover:bg-gray-100 dark:hover:bg-[#252525] cursor-pointer transition-colors duration-150 ${e.chapterId===r?"bg-primary-50 dark:bg-[#252525] font-medium":""}`,onClick:()=>m(e.chapterId),children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"text-sm text-gray-900 dark:text-gray-100",children:e.chapterName}),e.lexileScore&&(0,a.jsxs)("span",{className:"px-2 py-1 text-xs font-medium bg-primary-100 text-primary-800 dark:bg-[#252525] dark:text-primary-300 rounded-full",children:[e.lexileScore,"L"]})]})},e.chapterId))})})]})})})}function x({onClose:e}){let r=(0,i.M)(e=>e.isSettingsDialogVisible),t=(0,i.M)(e=>e.settings),n=(0,i.M)(e=>e.updateSettings),[o,l]=(0,s.useState)(t.fontSize),[c,h]=(0,s.useState)(t.lineHeight),[x,u]=(0,s.useState)(t.letterSpacing),[m,p]=(0,s.useState)(t.fontFamily),[g,b]=(0,s.useState)(t.theme),[k,v]=(0,s.useState)(!1);if((0,s.useEffect)(()=>{let e=()=>{v(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),(0,s.useEffect)(()=>{l(t.fontSize),h(t.lineHeight),u(t.letterSpacing),p(t.fontFamily),b(t.theme)},[t]),(0,s.useEffect)(()=>{document.documentElement.classList.toggle("dark","dark"===g)},[g]),!r)return null;let y=`fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center ${k?"p-0":"p-4"}`;return a.jsx("div",{className:y,children:(0,a.jsxs)("div",{className:`bg-white dark:bg-dark-100 rounded-lg shadow-lg w-full ${k?"h-full rounded-none":"max-w-2xl"} overflow-hidden`,children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b dark:border-dark-300",children:[a.jsx("h3",{className:"text-lg font-medium",children:"阅读设置"}),a.jsx(d.Z,{variant:"ghost",size:"sm",onClick:e,children:a.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),a.jsx("div",{className:`${k?"p-4":"p-4 md:p-6"} overflow-y-auto ${k?"h-[calc(100vh-60px)]":"max-h-[calc(100vh-150px)]"}`,children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8",children:[(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2",children:"字体大小"}),(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-l-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>l(Math.max(12,o-1)),children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),a.jsx("input",{type:"range",min:"12",max:"24",step:"1",value:o,onChange:e=>l(parseInt(e.target.value,10)),className:"slider flex-1 mx-2"}),a.jsx("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-r-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>l(Math.min(24,o+1)),children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:[o,"px"]})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2",children:"行高"}),(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-l-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>h(Math.max(1.2,c-.1)),children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),a.jsx("input",{type:"range",min:"1.2",max:"2.0",step:"0.1",value:c,onChange:e=>h(parseFloat(e.target.value)),className:"slider flex-1 mx-2"}),a.jsx("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-r-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>h(Math.min(2,c+.1)),children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]}),a.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:c.toFixed(1)})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2",children:"字间距"}),(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-l-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>u(Math.max(0,x-.5)),children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),a.jsx("input",{type:"range",min:"0",max:"5",step:"0.5",value:x,onChange:e=>u(parseFloat(e.target.value)),className:"slider flex-1 mx-2"}),a.jsx("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-r-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>u(Math.min(5,x+.5)),children:a.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:[x.toFixed(1),"px"]})]})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2",children:"字体"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-2",children:[a.jsx("button",{className:`p-2 rounded-md border ${"serif"===m?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"}`,onClick:()=>p("serif"),children:a.jsx("span",{className:"font-serif",children:"衬线字体 (Serif)"})}),a.jsx("button",{className:`p-2 rounded-md border ${"sans"===m?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"}`,onClick:()=>p("sans"),children:a.jsx("span",{className:"font-sans",children:"无衬线字体 (Sans)"})}),a.jsx("button",{className:`p-2 rounded-md border ${"mono"===m?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"}`,onClick:()=>p("mono"),children:a.jsx("span",{className:"font-mono",children:"等宽字体 (Mono)"})})]})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-2",children:"主题"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-2",children:[a.jsx("button",{className:`p-2 rounded-md border ${"light"===g?"bg-primary-50 border-primary-200":"bg-white border-gray-200"}`,onClick:()=>b("light"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("svg",{className:"h-5 w-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"})}),a.jsx("span",{children:"浅色主题"})]})}),a.jsx("button",{className:`p-2 rounded-md border ${"dark"===g?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"}`,onClick:()=>b("dark"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("svg",{className:"h-5 w-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})}),a.jsx("span",{children:"深色主题"})]})})]})]})]})]})}),(0,a.jsxs)("div",{className:"flex justify-end gap-2 p-4 border-t dark:border-dark-300",children:[a.jsx(d.Z,{variant:"ghost",onClick:e,children:"取消"}),a.jsx(d.Z,{variant:"primary",onClick:()=>{n({fontSize:o,lineHeight:c,letterSpacing:x,fontFamily:m,theme:g}),e()},children:"保存"})]})]})})}var u=t(5578);function m({bookId:e,chapterId:r}){let[t,n]=(0,s.useState)(!1),[o,l]=(0,s.useState)({x:0,y:0}),[d,c]=(0,s.useState)(""),[h,x]=(0,s.useState)(null),u=(0,i.M)(e=>e.setToolbarVisible),[m,p]=(0,s.useState)(!1),[g,b]=(0,s.useState)(!1),[k,v]=(0,s.useState)(null),[y,f]=(0,s.useState)(!1),[j,w]=(0,s.useState)(!1),[N,C]=(0,s.useState)(""),L=(0,s.useRef)(null),[S,M]=(0,s.useState)(!1),[E,I]=(0,s.useState)(!1),z=(0,s.useRef)(null),[$,W]=(0,s.useState)(null);(0,s.useRef)(null),(0,s.useRef)(null),(0,s.useCallback)(e=>{let r;let t=[],a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);for(;r=a.nextNode();)r.textContent?.trim()&&t.push(r);return t},[]);let B=(0,s.useCallback)((e,r)=>{let t=document.caretRangeFromPoint(e,r);return t?{node:t.startContainer,offset:t.startOffset}:null},[]),O=(0,s.useCallback)((e,r,t,a)=>{let s=document.createRange();s.setStart(e,r),s.setEnd(t,a);let n=window.getSelection();return n?(n.removeAllRanges(),n.addRange(s),n):null},[]),P=(0,s.useCallback)(()=>{let e=window.getSelection();if(!e||e.isCollapsed)return;let r=e.toString().trim();if(!r)return;let t=e.getRangeAt(0).getBoundingClientRect();u(!1),l({x:S?Math.min(Math.max(t.left+t.width/2,150),window.innerWidth-150):t.left+t.width/2,y:S?Math.max(t.top-65,70):t.top-55}),c(r),x(e),n(!0),p(!1),v(null),f(!1),w(!1)},[u,S]),R=(0,s.useCallback)(e=>{let r=document.getElementById("text-selector-toolbar"),t=document.getElementById("translation-tooltip");r&&r.contains(e.target)||t&&t.contains(e.target)||(n(!1),b(!1))},[]),q=(0,s.useCallback)(e=>{if(1!==e.touches.length)return;let r=e.touches[0];B(r.clientX,r.clientY)&&(z.current={x:r.clientX,y:r.clientY,target:e.target},I(!0),W(null))},[B]),H=(0,s.useCallback)(e=>{if(!z.current||!E||1!==e.touches.length)return;let r=e.touches[0],t=B(z.current.x,z.current.y),a=B(r.clientX,r.clientY);t&&a&&O(t.node,t.offset,a.node,a.offset)&&P()},[E,B,O,P]),U=(0,s.useCallback)(e=>{I(!1);let r=document.getElementById("text-selector-toolbar"),t=document.getElementById("translation-tooltip");r&&r.contains(e.target)||t&&t.contains(e.target)||setTimeout(()=>{let r=window.getSelection();r&&!r.isCollapsed&&r.toString().trim()?P():R(e)},100)},[P,R]);(0,s.useEffect)(()=>{let e=()=>{M(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),(0,s.useEffect)(()=>{if(S){let e=document.querySelector('meta[name="viewport"]');e||((e=document.createElement("meta")).setAttribute("name","viewport"),document.head.appendChild(e)),e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no");let r=e=>{e.touches.length>1&&e.preventDefault()};return document.addEventListener("touchmove",r,{passive:!1}),()=>{document.removeEventListener("touchmove",r),e&&e.setAttribute("content","width=device-width, initial-scale=1.0")}}},[S]),(0,s.useEffect)(()=>{S&&(document.body.style.userSelect="text",document.body.style.webkitUserSelect="text",document.body.style.msUserSelect="text",document.body.style.MozUserSelect="text");let e=e=>{let r=document.getElementById("text-selector-toolbar"),t=document.getElementById("translation-tooltip");r&&r.contains(e.target)||t&&t.contains(e.target)||setTimeout(()=>{let r=window.getSelection();r&&!r.isCollapsed&&r.toString().trim()?P():R(e)},10)};return(document.addEventListener("mouseup",e),document.addEventListener("mousedown",R),S)?(document.addEventListener("touchstart",q,{passive:!0}),document.addEventListener("touchmove",H,{passive:!0}),document.addEventListener("touchend",U),()=>{document.removeEventListener("mouseup",e),document.removeEventListener("mousedown",R),document.removeEventListener("touchstart",q),document.removeEventListener("touchmove",H),document.removeEventListener("touchend",U),document.body.style.userSelect="",document.body.style.webkitUserSelect="",document.body.style.msUserSelect="",document.body.style.MozUserSelect=""}):()=>{document.removeEventListener("mouseup",e),document.removeEventListener("mousedown",R)}},[P,R,S,E,q,H,U]);let T=t=>{if(!h)return;let a=h.getRangeAt(0),s=document.createElement("span");s.className=`highlight-${t}`,s.dataset.bookId=e,s.dataset.chapterId=r,s.dataset.style=t,a.surroundContents(s);let o=JSON.parse(localStorage.getItem(`highlights-${e}-${r}`)||"[]");o.push({text:d,style:t,timestamp:new Date().toISOString()}),localStorage.setItem(`highlights-${e}-${r}`,JSON.stringify(o)),S||n(!1)},A=e=>{e.stopPropagation(),k?.speakUrl&&(L.current?L.current.src=k.speakUrl:L.current=new Audio(k.speakUrl),L.current.play().catch(e=>{console.error("播放音频失败:",e)}))},_=e=>{e.stopPropagation(),k?.tSpeakUrl&&(L.current?L.current.src=k.tSpeakUrl:L.current=new Audio(k.tSpeakUrl),L.current.play().catch(e=>{console.error("播放音频失败:",e)}))},F=async e=>{if(e?.stopPropagation(),y)return;f(!0),w(!1);let r=e?d:N;e?p(!0):b(!0);try{let e=await fetch(`/api/translate?text=${encodeURIComponent(r)}&type=text`);if(!e.ok)throw Error("翻译请求失败");let t=await e.json();if("0"===t.errorCode)v(t);else throw Error(t.message||"翻译失败")}catch(e){console.error("翻译出错:",e),w(!0)}finally{f(!1)}},V=(0,s.useCallback)(()=>{p(!1),b(!1),n(!1),u(!1)},[u]);return t||m||g?(0,a.jsxs)(a.Fragment,{children:[t&&a.jsx("div",{id:"text-selector-toolbar",className:"fixed z-[60] transform -translate-x-1/2",style:{left:o.x,top:o.y},children:(0,a.jsxs)("div",{className:`bg-white/90 dark:bg-[#1a1a1a]/95 backdrop-blur-md rounded-full shadow-lg border border-gray-200 dark:border-gray-800 flex items-center h-12 px-2 ${S?"flex-wrap gap-1 justify-center w-[calc(100vw-32px)] max-w-md":""}`,children:[(0,a.jsxs)("button",{className:`flex flex-col items-center justify-center ${S?"w-14":"w-16"} h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group`,onClick:()=>{navigator.clipboard.writeText(d),S||n(!1)},"aria-label":"复制文本",children:[a.jsx("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"})}),a.jsx("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"复制"})]}),(0,a.jsxs)("button",{className:`flex flex-col items-center justify-center ${S?"w-14":"w-16"} h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group`,onClick:()=>T("background"),"aria-label":"马克笔高亮",children:[a.jsx("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),a.jsx("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"马克笔"})]}),(0,a.jsxs)("button",{className:`flex flex-col items-center justify-center ${S?"w-14":"w-16"} h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group`,onClick:()=>T("wave"),"aria-label":"波浪线高亮",children:[a.jsx("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),a.jsx("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"波浪线"})]}),(0,a.jsxs)("button",{className:`flex flex-col items-center justify-center ${S?"w-14":"w-16"} h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group`,onClick:()=>T("underline"),"aria-label":"直线高亮",children:[a.jsx("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 12h16M4 18h16"})}),a.jsx("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"直线"})]}),(0,a.jsxs)("button",{className:`flex flex-col items-center justify-center ${S?"w-14":"w-16"} h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group`,onClick:F,"aria-label":"翻译文本",children:[a.jsx("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"})}),a.jsx("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"翻译"})]})]})}),m&&(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 z-[9998] bg-black/30",onClick:V,style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.3)"}}),a.jsx("div",{id:"translation-tooltip",className:"fixed z-[9999] bg-white dark:bg-[#1a1a1a] shadow-xl rounded-lg border dark:border-gray-800 p-4 w-[calc(100vw-32px)] max-w-sm",style:{position:"fixed",left:"50%",top:"50%",transform:"translate(-50%, -50%)",maxHeight:"70vh",overflowY:"auto"},onClick:e=>e.stopPropagation(),children:a.jsx("div",{className:"space-y-2",children:y?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"})}):k?(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2",children:[a.jsx("div",{className:"break-words max-w-[calc(100%-60px)]",children:d}),k?.speakUrl&&a.jsx("button",{onClick:A,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放原文发音",children:a.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]}),a.jsx("div",{className:"border-b border-gray-200 dark:border-gray-800 mb-2"}),a.jsx("div",{children:k.basic?(0,a.jsxs)("div",{children:[a.jsx("div",{className:"font-medium text-lg mb-1 dark:text-white",children:k.basic.phonetic&&`[${k.basic.phonetic}]`}),a.jsx("div",{className:"space-y-1",children:k.basic.explains.map((e,r)=>a.jsx("div",{className:"text-sm dark:text-gray-300",children:e},r))})]}):(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"text-sm dark:text-gray-300 break-words max-w-[calc(100%-60px)]",children:k.translation&&k.translation.length>0&&a.jsx("span",{children:k.translation[0]})}),k.tSpeakUrl&&a.jsx("button",{onClick:_,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放翻译发音",children:a.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]})})]}):null})})]}),g&&(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 z-[9998] bg-black/30",onClick:()=>b(!1),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.3)"}}),a.jsx("div",{id:"word-translation-tooltip",className:"fixed z-[9999] bg-white dark:bg-[#1a1a1a] shadow-xl rounded-lg border dark:border-gray-800 p-4 w-[calc(100vw-32px)] max-w-sm",style:{position:"fixed",left:"50%",top:"50%",transform:"translate(-50%, -50%)",maxHeight:"70vh",overflowY:"auto"},onClick:e=>e.stopPropagation(),children:a.jsx("div",{className:"space-y-2",children:y?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"})}):k?(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2",children:[a.jsx("div",{className:"break-words max-w-[calc(100%-60px)]",children:N}),k?.speakUrl&&a.jsx("button",{onClick:A,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放原文发音",children:a.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]}),a.jsx("div",{className:"border-b border-gray-200 dark:border-gray-800 mb-2"}),a.jsx("div",{children:k.basic?(0,a.jsxs)("div",{children:[a.jsx("div",{className:"font-medium text-lg mb-1 dark:text-white",children:k.basic.phonetic&&`[${k.basic.phonetic}]`}),a.jsx("div",{className:"space-y-1",children:k.basic.explains.map((e,r)=>a.jsx("div",{className:"text-sm dark:text-gray-300",children:e},r))})]}):(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"text-sm dark:text-gray-300 break-words max-w-[calc(100%-60px)]",children:k.translation&&k.translation.length>0&&a.jsx("span",{children:k.translation[0]})}),k.tSpeakUrl&&a.jsx("button",{onClick:_,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放翻译发音",children:a.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]})})]}):null})})]})]}):null}let p=({onPrevChapter:e,onNextChapter:r,onOpenChapterList:t,onOpenSettings:n,hasPrevChapter:o,hasNextChapter:i,currentChapter:l,totalChapters:d})=>{let[c,h]=(0,s.useState)(!0),[x,u]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{let e=()=>{u(window.innerWidth<768),window.innerWidth<768&&h(!1)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),a.jsx("div",{className:"fixed left-0 top-1/2 transform -translate-y-1/2 z-30",children:(0,a.jsxs)("nav",{className:`${c?"bg-white/90 dark:bg-[#1a1a1a]/95":"bg-[#1b1b1b]"} rounded-r-lg px-2 py-4 shadow-lg border border-gray-200 dark:border-gray-800 backdrop-blur-md flex flex-col items-center space-y-6 transition-all duration-300 ${c?"w-16 opacity-100":"w-3 opacity-90"}`,children:[a.jsx("button",{onClick:()=>{h(!c)},className:"absolute right-0 top-1/2 transform -translate-y-1/2 h-16 w-3 bg-[#1b1b1b] rounded-r transition-all duration-300 flex items-center justify-center","aria-label":c?"收起导航":"展开导航",children:a.jsx("div",{className:`w-1 h-8 bg-gray-400/50 rounded-full transition-all duration-300 ${c?"opacity-100":"opacity-70"}`})}),c&&(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"relative group",children:(0,a.jsxs)("button",{className:`p-2 rounded-full ${o?"hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer":"opacity-50 cursor-not-allowed"} transition-all duration-300 text-gray-700 dark:text-gray-300`,onClick:e,disabled:!o,"aria-label":"上一章",children:[a.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("polyline",{points:"15 18 9 12 15 6"})}),!x&&a.jsx("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["上一章",a.jsx("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:a.jsx("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),a.jsx("div",{className:"relative group",children:(0,a.jsxs)("button",{className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer transition-all duration-300 text-gray-700 dark:text-gray-300",onClick:t,"aria-label":"章节目录",children:[(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"8",y1:"6",x2:"21",y2:"6"}),a.jsx("line",{x1:"8",y1:"12",x2:"21",y2:"12"}),a.jsx("line",{x1:"8",y1:"18",x2:"21",y2:"18"}),a.jsx("line",{x1:"3",y1:"6",x2:"3.01",y2:"6"}),a.jsx("line",{x1:"3",y1:"12",x2:"3.01",y2:"12"}),a.jsx("line",{x1:"3",y1:"18",x2:"3.01",y2:"18"})]}),!x&&a.jsx("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["章节目录",a.jsx("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:a.jsx("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),a.jsx("div",{className:"relative group",children:(0,a.jsxs)("button",{className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer transition-all duration-300 text-gray-700 dark:text-gray-300",onClick:n,"aria-label":"设置",children:[(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:12,cy:12,r:3}),a.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]}),!x&&a.jsx("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["设置",a.jsx("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:a.jsx("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),a.jsx("div",{className:"relative group",children:(0,a.jsxs)("button",{className:`p-2 rounded-full ${i?"hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer":"opacity-50 cursor-not-allowed"} transition-all duration-300 text-gray-700 dark:text-gray-300`,onClick:r,disabled:!i,"aria-label":"下一章",children:[a.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("polyline",{points:"9 18 15 12 9 6"})}),!x&&a.jsx("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["下一章",a.jsx("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:a.jsx("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),(0,a.jsxs)("div",{className:"bg-gray-100 dark:bg-[#1a1a1a] rounded-full px-2 py-1 text-xs text-gray-700 dark:text-gray-300 border border-transparent dark:border-gray-800",children:[l,"/",d]})]})]})})};function g({word:e}){let[r,t]=(0,s.useState)(null),[n,o]=(0,s.useState)(!1),[i,l]=(0,s.useState)(!1),[d,c]=(0,s.useState)(!1),h=(0,s.useRef)(null),x=(0,s.useRef)(null),u=(0,s.useRef)(null),[m,p]=(0,s.useState)(!1);(0,s.useEffect)(()=>{let e=()=>{p(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]);let g=async()=>{if(!r){o(!0),l(!1);try{let r=await fetch(`/api/translate?text=${encodeURIComponent(e)}&type=word`);if(!r.ok)throw Error("翻译请求失败");let a=await r.json();if("0"===a.errorCode)t(a);else throw Error(a.message||"翻译失败")}catch(e){console.error("翻译出错:",e),l(!0)}finally{o(!1)}}},b=(()=>{if(!x.current)return{top:0,left:0};let e=x.current.getBoundingClientRect();if(m){let r=Math.min(Math.max(e.left+e.width/2,150),window.innerWidth-150);return{top:Math.max(e.top-10,50),left:r}}return{top:e.top-10,left:e.left+e.width/2}})();return(0,a.jsxs)(a.Fragment,{children:[a.jsx("span",{ref:x,className:"cursor-pointer hover:bg-primary-100 dark:hover:bg-primary-900/20 px-0.5 rounded transition-colors inline-block",onClick:e=>{e.stopPropagation(),c(!d),d||r||n||g()},children:e}),d&&a.jsx("div",{ref:h,className:"fixed z-[100] transform -translate-x-1/2 pointer-events-auto",style:{top:`${b.top-40}px`,left:`${b.left}px`,maxWidth:m?"calc(100vw - 40px)":"300px"},children:a.jsx("div",{className:"bg-white dark:bg-[#1a1a1a] rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 p-3 w-full",children:(0,a.jsxs)("div",{className:"relative",children:[n?(0,a.jsxs)("div",{className:"flex items-center justify-center py-2",children:[a.jsx("div",{className:"w-5 h-5 border-2 border-t-transparent border-primary-500 rounded-full animate-spin"}),a.jsx("span",{className:"ml-2 text-sm",children:"翻译中..."})]}):i?a.jsx("div",{className:"text-sm text-red-500",children:"翻译失败，请重试"}):r?(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("div",{className:"text-sm font-bold dark:text-gray-200 break-words max-w-[85%]",children:r.query}),r.speakUrl&&a.jsx("button",{onClick:()=>{r?.speakUrl&&(u.current?u.current.src=r.speakUrl:u.current=new Audio(r.speakUrl),u.current.play().catch(e=>{console.error("播放音频失败:",e)}))},className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 flex-shrink-0","aria-label":"播放原文发音",children:a.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[a.jsx("div",{className:"text-xs dark:text-gray-300 break-words max-w-[85%]",children:r.translation&&r.translation.length>0&&a.jsx("span",{children:r.translation[0]})}),r.tSpeakUrl&&a.jsx("button",{onClick:()=>{r?.tSpeakUrl&&(u.current?u.current.src=r.tSpeakUrl:u.current=new Audio(r.tSpeakUrl),u.current.play().catch(e=>{console.error("播放音频失败:",e)}))},className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 flex-shrink-0","aria-label":"播放翻译发音",children:a.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]})]}):a.jsx("div",{className:"text-sm dark:text-gray-300",children:"正在加载翻译..."}),!m&&a.jsx("div",{className:"absolute left-1/2 bottom-0 transform -translate-x-1/2 translate-y-full",children:a.jsx("div",{className:"border-8 border-transparent border-t-white dark:border-t-[#1a1a1a]"})})]})})})]})}function b({bookId:e,initialChapterId:r}){let t=(0,o.useRouter)(),d=(0,s.useRef)(null),b=(0,s.useRef)(0),k=(0,i.M)(e=>e.settings),v=(0,i.M)(e=>e.isToolbarVisible),y=(0,i.M)(e=>e.setToolbarVisible),f=(0,i.M)(e=>e.setSettingsDialogVisible),j=(0,i.M)(e=>e.setChapterListVisible),w=(0,i.M)(r=>r.readingProgress[e]),N=(0,i.M)(e=>e.updateReadingProgress),C=(0,i.M)(e=>e.aiSettings),[L,S]=(0,s.useState)(r),[M,E]=(0,s.useState)(r),[I,z]=(0,s.useState)(!1),[$,W]=(0,s.useState)(0),[B,O]=(0,s.useState)(!1);(0,s.useEffect)(()=>{document.documentElement.classList.toggle("dark","dark"===k.theme)},[k.theme]);let{data:P}=(0,n.useQuery)(["book",e],()=>(0,l.F3)(e),{enabled:!!e,staleTime:1/0}),{data:R}=(0,n.useQuery)(["chaptersWithLexile",e],()=>(0,l.p0)(e),{enabled:!!e,staleTime:6e4}),{data:q}=(0,n.useQuery)(["chapters",e],()=>(0,l.lc)(e),{enabled:!!e&&!R,staleTime:1/0}),{data:H,isLoading:U,error:T,refetch:A}=(0,n.useQuery)(["chapter",M,C.enabled],async()=>{if(console.log("开始加载目标章节:",M),!M)throw Error("无效的章节ID");try{let e=await (0,l.xQ)(M,C.enabled,C.enabled?C.lexileScore:void 0,C.priorityWords.length>0?C.priorityWords.join(","):void 0);return console.log("章节加载成功:",e.chapterName),S(M),e}catch(e){throw console.error("章节加载失败:",e),e}},{enabled:!!M,retry:2,staleTime:0,cacheTime:0,refetchOnWindowFocus:!1,onSuccess:r=>{console.log("章节内容已更新:",r.chapterName),d.current&&(d.current.scrollTop=0),W(0),O(!1),console.log("章节加载成功，再次确认更新阅读进度:",r.chapterId),N({bookId:e,chapterId:r.chapterId,pageIndex:0,percentage:0,lastRead:new Date().toISOString()})},onError:e=>{console.error("加载章节失败:",e),O(!1)}}),_=(0,s.useCallback)(async r=>{if(console.log("准备切换到章节:",r),r===M){console.log("已经是目标章节，无需切换");return}try{E(r),console.log("立即更新阅读进度，章节ID:",r),N({bookId:e,chapterId:r,pageIndex:0,percentage:0,lastRead:new Date().toISOString()}),window.history.replaceState({chapterId:r},"",`/books/${e}?chapter=${r}`),console.log("目标章节已更新，等待加载新内容")}catch(e){console.error("切换章节失败:",e)}},[e,M,N]);(0,s.useEffect)(()=>{let e=new URLSearchParams(window.location.search).get("chapter");e&&e!==M&&E(e)},[M]),(0,s.useEffect)(()=>{console.log("当前阅读进度状态:",{bookId:e,readingProgress:w,currentChapterId:L,targetChapterId:M,storeState:i.M.getState().readingProgress})},[e,w,L,M]),(0,s.useEffect)(()=>{H?.chapterContent&&d.current&&(d.current.scrollTop=0)},[H]);let F=(0,s.useCallback)(()=>{if(!q?.content||!H)return;let e=[...q.content].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}),r=e.findIndex(e=>e.chapterId===H.chapterId);if(r>0){let t=e[r-1];console.log("切换到上一章:",t.chapterName),_(t.chapterId)}},[q,H,_]),V=(0,s.useCallback)(()=>{if(!q?.content||!H)return;let e=[...q.content].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}),r=e.findIndex(e=>e.chapterId===H.chapterId);if(r<e.length-1){let t=e[r+1];console.log("切换到下一章:",t.chapterName),_(t.chapterId)}},[q,H,_]),D=(0,s.useCallback)(()=>{if(!d.current)return;let{scrollTop:e,scrollHeight:r,clientHeight:t}=d.current;W(Math.min(Math.max(e/(r-t),0),1)),e>b.current+50?(y(!1),b.current=e):e<b.current-50&&(y(!0),b.current=e)},[y]);(0,s.useEffect)(()=>{let e=d.current;if(e)return e.addEventListener("scroll",D),()=>{e.removeEventListener("scroll",D)}},[D]),(0,s.useEffect)(()=>{P&&H&&$>0&&N({bookId:e,chapterId:H.chapterId,pageIndex:0,percentage:$,lastRead:new Date().toISOString()})},[P,H,$,e,N]),(0,s.useEffect)(()=>{if(d.current&&w&&H&&w.chapterId===H.chapterId){let{scrollHeight:e,clientHeight:r}=d.current,t=w.percentage*(e-r);d.current.scrollTop=t,b.current=t}},[H,w]),(0,s.useEffect)(()=>{if(d.current&&H)try{let r=JSON.parse(localStorage.getItem(`highlights-${e}-${H.chapterId}`)||"[]");d.current.querySelectorAll("[data-book-id]").forEach(e=>{let r=e.parentNode;r&&r.replaceChild(document.createTextNode(e.textContent||""),e)});let t=d.current.textContent||"";r.forEach(r=>{let a=t.indexOf(r.text);if(-1!==a){let t=document.createRange(),s=d.current.firstChild;if(s){t.setStart(s,a),t.setEnd(s,a+r.text.length);let n=document.createElement("span");n.className=`highlight-${r.style}`,n.dataset.bookId=e,n.dataset.chapterId=H.chapterId,n.dataset.style=r.style,t.surroundContents(n)}}})}catch(e){console.error("恢复高亮失败:",e)}},[e,H]);let Z=(0,s.useCallback)(()=>{y(!v)},[v,y]),Q=(0,s.useCallback)(()=>{z(!0)},[]);if(!P||!q)return a.jsx("div",{className:"flex items-center justify-center h-screen",children:"加载中..."});if(U)return a.jsx("div",{className:"flex items-center justify-center h-screen",children:"正在加载章节内容..."});if(T)return(0,a.jsxs)("div",{className:"flex items-center justify-center h-screen flex-col",children:[a.jsx("div",{className:"text-red-500 mb-4",children:"加载章节内容失败"}),a.jsx("button",{className:"px-4 py-2 bg-primary-500 text-white rounded-md",onClick:()=>A(),children:"重试"})]});if(!H)return(0,a.jsxs)("div",{className:"flex items-center justify-center h-screen flex-col",children:[a.jsx("div",{className:"text-red-500 mb-4",children:"章节不存在"}),q.content.length>0&&a.jsx("button",{className:"px-4 py-2 bg-primary-500 text-white rounded-md",onClick:()=>_(q.content[0].chapterId),children:"加载第一章"})]});let X=H?.chapterContent?H.chapterContent.split("\n").filter(Boolean).map((e,r)=>{let t;let s=/\b([a-zA-Z]+)\b/g,n=0,o=[];for(;null!==(t=s.exec(e));)t.index>n&&o.push(e.substring(n,t.index)),o.push(a.jsx(g,{word:t[0]},`${r}-${t.index}`)),n=t.index+t[0].length;return n<e.length&&o.push(e.substring(n)),a.jsx("p",{className:"mb-4",children:o},r)}):[],Y=q?.content?[...q.content].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}):[],G=Y.findIndex(e=>e.chapterId===H?.chapterId),J=G>0,K=G<Y.length-1,ee=Y.length;return(0,a.jsxs)("div",{className:"relative h-screen bg-white dark:bg-dark-100 flex flex-col",children:[a.jsx(c,{title:`${P?.bookName||""} - ${H?.chapterName||""}`,onBack:()=>t.back(),onOpenChapterList:()=>j(!0),onOpenSettings:()=>f(!0),onToggleAI:Q}),a.jsx("div",{ref:d,className:"flex-1 overflow-y-auto px-4 md:px-0",onClick:Z,children:(0,a.jsxs)("div",{className:"max-w-3xl mx-auto py-8",children:[a.jsx("h1",{className:"text-2xl font-bold mb-6 text-center",children:H?.chapterName}),a.jsx("div",{className:"reader-content",style:{fontSize:`${k.fontSize}px`,fontFamily:k.fontFamily,lineHeight:k.lineHeight,letterSpacing:`${k.letterSpacing}px`},children:X.length>0?X:a.jsx("div",{className:"text-center py-12 text-gray-500",children:"章节内容为空"})}),(0,a.jsxs)("div",{className:"mt-12 pt-6 border-t dark:border-dark-300 flex flex-col items-center",children:[(0,a.jsxs)("div",{className:"flex space-x-4 justify-center",children:[J&&a.jsx("button",{className:"px-6 py-3 bg-primary-100 text-primary-800 dark:bg-primary-900/20 dark:text-primary-100 rounded-md hover:bg-primary-200 dark:hover:bg-primary-900/30 transition-colors",onClick:F,children:"上一章"}),K&&a.jsx("button",{className:"px-6 py-3 bg-primary-500 text-white rounded-md hover:bg-primary-600 transition-colors",onClick:V,children:"下一章"})]}),a.jsx("button",{className:"mt-4 text-primary-500 dark:text-primary-400 hover:underline",onClick:()=>j(!0),children:"查看目录"})]})]})}),a.jsx(p,{onPrevChapter:F,onNextChapter:V,onOpenChapterList:()=>j(!0),onOpenSettings:()=>f(!0),hasPrevChapter:J,hasNextChapter:K,currentChapter:G+1,totalChapters:ee}),a.jsx(m,{bookId:e,chapterId:H?.chapterId||""}),a.jsx(h,{chapters:R?.content||q?.content||[],currentChapterId:L,onChapterSelect:_,onClose:()=>j(!1)}),a.jsx(x,{onClose:()=>f(!1)}),a.jsx(u.Z,{isOpen:I,enabled:C.enabled,onEnableChange:e=>{i.M.getState().updateAISettings({...C,enabled:e})},onClose:()=>z(!1)})]})}function k(){let e=(0,o.useParams)(),r=e?.id;if(!r)return a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"text-lg text-red-500",children:"无效的书籍ID"})});console.log("书籍ID:",r);let t=(0,i.M)(e=>e.readingProgress[r]),{data:d,isLoading:c,error:h}=(0,n.useQuery)(["book",r],()=>(0,l.F3)(r),{enabled:!!r,retry:1,onError:e=>console.error("获取书籍详情失败:",e)}),{data:x,isLoading:u,error:m}=(0,n.useQuery)(["chapters",r],()=>(0,l.lc)(r),{enabled:!!r,retry:1,onError:e=>console.error("获取章节列表失败:",e)});if((0,s.useEffect)(()=>{let e=i.M.getState().settings.theme;document.documentElement.classList.toggle("dark","dark"===e)},[]),c||u)return a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"text-lg",children:"加载中..."})});if(h||m)return a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"text-lg text-red-500",children:h?"加载书籍失败":"加载章节列表失败"})});if(!d||!x||0===x.content.length)return a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"text-lg text-red-500",children:d?"该书籍暂无章节":"书籍不存在"})});console.log("书籍信息:",d),console.log("章节列表:",x.content);let p=t?.chapterId||x.content[0]?.chapterId;return(console.log("初始章节ID:",p),p)?a.jsx(b,{bookId:r,initialChapterId:p}):a.jsx("div",{className:"flex items-center justify-center min-h-screen",children:a.jsx("div",{className:"text-lg text-red-500",children:"无法确定初始章节"})})}},6017:(e,r,t)=>{"use strict";function a({children:e}){return e}t.r(r),t.d(r,{default:()=>a})},391:(e,r,t)=>{"use strict";t.r(r),t.d(r,{$$typeof:()=>n,__esModule:()=>s,default:()=>o});let a=(0,t(6843).createProxy)(String.raw`E:\project\reading\reading-app\app\books\[id]\page.tsx`),{__esModule:s,$$typeof:n}=a,o=a.default},9733:(e,r,t)=>{"use strict";t.r(r),t.d(r,{$$typeof:()=>n,__esModule:()=>s,default:()=>o});let a=(0,t(6843).createProxy)(String.raw`E:\project\reading\reading-app\app\books\layout.tsx`),{__esModule:s,$$typeof:n}=a,o=a.default}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[583,16,650],()=>t(6497));module.exports=a})();