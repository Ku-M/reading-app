(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[678],{123:function(e,r,t){Promise.resolve().then(t.bind(t,4085))},4085:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return k}});var a=t(3827),s=t(4090),n=t(5230),o=t(7907),l=t(333),i=t(826),d=t(9313);function c(e){let{onBack:r,onOpenChapterList:t,onOpenSettings:n,onToggleAI:o,title:i}=e,c=(0,l.M)(e=>e.isToolbarVisible),h=(0,l.M)(e=>e.settings.theme),x=(0,l.M)(e=>e.updateSettings),m=(0,s.useCallback)(()=>{x({theme:"light"===h?"dark":"light"})},[h,x]);return(0,a.jsx)("div",{className:c?"toolbar":"toolbar toolbar-hidden",children:(0,a.jsxs)("div",{className:"flex items-center justify-between px-4 py-2",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsx)(d.Z,{variant:"ghost",size:"sm",onClick:r,children:(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,a.jsx)("div",{className:"text-sm font-medium hidden md:block",children:(0,a.jsx)("div",{className:"truncate max-w-md",children:i})})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(d.Z,{variant:"ghost",size:"sm",onClick:t,title:"目录",children:(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 12h16M4 18h16"})})}),(0,a.jsx)(d.Z,{variant:"ghost",size:"sm",onClick:o,title:"AI 转写",children:(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})})}),(0,a.jsx)(d.Z,{variant:"ghost",size:"sm",onClick:n,title:"设置",children:(0,a.jsxs)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}),(0,a.jsx)(d.Z,{variant:"ghost",size:"sm",onClick:m,title:"light"===h?"夜间模式":"日间模式",children:"light"===h?(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})}):(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"})})})]})]})})}function h(e){let{chapters:r,currentChapterId:t,onChapterSelect:n,onClose:o}=e,i=(0,l.M)(e=>e.isChapterListVisible),d=(0,l.M)(e=>e.setChapterListVisible),c=(0,l.M)(e=>e.setToolbarVisible),[h,x]=(0,s.useState)(""),m=(0,s.useRef)(null);(0,s.useEffect)(()=>{i&&c(!1)},[i,c]);let u=[...r].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}).filter(e=>e.chapterName.toLowerCase().includes(h.toLowerCase()));(0,s.useEffect)(()=>{if(i&&t&&m.current){let e=document.getElementById("chapter-".concat(t));e&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"center"})},100)}},[i,t]);let p=(0,s.useCallback)(e=>{if(console.log("章节列表中点击章节:",e,"当前章节:",t),e===t){console.log("点击了当前章节，关闭目录"),o();return}console.log("选择新章节:",e),n(e),setTimeout(()=>{o()},200)},[t,n,o]),g=()=>{d(!1),o()};return(0,a.jsx)("div",{className:"chapter-list fixed inset-0 z-40 bg-black bg-opacity-50 transition-opacity ".concat(i?"opacity-100":"opacity-0 pointer-events-none"),onClick:e=>{e.target===e.currentTarget&&g()},children:(0,a.jsx)("div",{className:"absolute right-0 top-0 bottom-0 w-80 bg-white dark:bg-[#1a1a1a] shadow-xl transition-transform ".concat(i?"translate-x-0":"translate-x-full"),children:(0,a.jsxs)("div",{className:"flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:"目录"}),(0,a.jsx)("button",{onClick:g,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:(0,a.jsx)("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsx)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-800",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:"text",placeholder:"搜索章节...",value:h,onChange:e=>x(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-[#252525] dark:text-white"}),(0,a.jsx)("svg",{className:"absolute left-3 top-2.5 w-5 h-5 text-gray-400 dark:text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto scrollbar-hide",ref:m,children:0===u.length?(0,a.jsx)("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:h?"没有找到匹配的章节":"没有章节"}):(0,a.jsx)("ul",{className:"divide-y divide-gray-200 dark:divide-gray-800",children:u.map(e=>(0,a.jsx)("li",{id:"chapter-".concat(e.chapterId),className:"p-4 hover:bg-gray-100 dark:hover:bg-[#252525] cursor-pointer transition-colors duration-150 ".concat(e.chapterId===t?"bg-primary-50 dark:bg-[#252525] font-medium":""),onClick:()=>p(e.chapterId),children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("div",{className:"text-sm text-gray-900 dark:text-gray-100",children:e.chapterName}),e.lexileScore&&(0,a.jsxs)("span",{className:"px-2 py-1 text-xs font-medium bg-primary-100 text-primary-800 dark:bg-[#252525] dark:text-primary-300 rounded-full",children:[e.lexileScore,"L"]})]})},e.chapterId))})})]})})})}function x(e){let{onClose:r}=e,t=(0,l.M)(e=>e.isSettingsDialogVisible),n=(0,l.M)(e=>e.settings),o=(0,l.M)(e=>e.updateSettings),[i,c]=(0,s.useState)(n.fontSize),[h,x]=(0,s.useState)(n.lineHeight),[m,u]=(0,s.useState)(n.letterSpacing),[p,g]=(0,s.useState)(n.fontFamily),[b,k]=(0,s.useState)(n.theme),[v,f]=(0,s.useState)(!1);return((0,s.useEffect)(()=>{let e=()=>{f(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),(0,s.useEffect)(()=>{c(n.fontSize),x(n.lineHeight),u(n.letterSpacing),g(n.fontFamily),k(n.theme)},[n]),(0,s.useEffect)(()=>{document.documentElement.classList.toggle("dark","dark"===b)},[b]),t)?(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center ".concat(v?"p-0":"p-4"),children:(0,a.jsxs)("div",{className:"bg-white dark:bg-dark-100 rounded-lg shadow-lg w-full ".concat(v?"h-full rounded-none":"max-w-2xl"," overflow-hidden"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b dark:border-dark-300",children:[(0,a.jsx)("h3",{className:"text-lg font-medium",children:"阅读设置"}),(0,a.jsx)(d.Z,{variant:"ghost",size:"sm",onClick:r,children:(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,a.jsx)("div",{className:"".concat(v?"p-4":"p-4 md:p-6"," overflow-y-auto ").concat(v?"h-[calc(100vh-60px)]":"max-h-[calc(100vh-150px)]"),children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8",children:[(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"字体大小"}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-l-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>c(Math.max(12,i-1)),children:(0,a.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),(0,a.jsx)("input",{type:"range",min:"12",max:"24",step:"1",value:i,onChange:e=>c(parseInt(e.target.value,10)),className:"slider flex-1 mx-2"}),(0,a.jsx)("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-r-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>c(Math.min(24,i+1)),children:(0,a.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:[i,"px"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"行高"}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-l-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>x(Math.max(1.2,h-.1)),children:(0,a.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),(0,a.jsx)("input",{type:"range",min:"1.2",max:"2.0",step:"0.1",value:h,onChange:e=>x(parseFloat(e.target.value)),className:"slider flex-1 mx-2"}),(0,a.jsx)("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-r-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>x(Math.min(2,h+.1)),children:(0,a.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]}),(0,a.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:h.toFixed(1)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"字间距"}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-l-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>u(Math.max(0,m-.5)),children:(0,a.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),(0,a.jsx)("input",{type:"range",min:"0",max:"5",step:"0.5",value:m,onChange:e=>u(parseFloat(e.target.value)),className:"slider flex-1 mx-2"}),(0,a.jsx)("button",{className:"p-2 bg-gray-100 dark:bg-dark-200 rounded-r-md hover:bg-gray-200 dark:hover:bg-dark-300",onClick:()=>u(Math.min(5,m+.5)),children:(0,a.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:[m.toFixed(1),"px"]})]})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"字体"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-2",children:[(0,a.jsx)("button",{className:"p-2 rounded-md border ".concat("serif"===p?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"),onClick:()=>g("serif"),children:(0,a.jsx)("span",{className:"font-serif",children:"衬线字体 (Serif)"})}),(0,a.jsx)("button",{className:"p-2 rounded-md border ".concat("sans"===p?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"),onClick:()=>g("sans"),children:(0,a.jsx)("span",{className:"font-sans",children:"无衬线字体 (Sans)"})}),(0,a.jsx)("button",{className:"p-2 rounded-md border ".concat("mono"===p?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"),onClick:()=>g("mono"),children:(0,a.jsx)("span",{className:"font-mono",children:"等宽字体 (Mono)"})})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"主题"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-2",children:[(0,a.jsx)("button",{className:"p-2 rounded-md border ".concat("light"===b?"bg-primary-50 border-primary-200":"bg-white border-gray-200"),onClick:()=>k("light"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("svg",{className:"h-5 w-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"})}),(0,a.jsx)("span",{children:"浅色主题"})]})}),(0,a.jsx)("button",{className:"p-2 rounded-md border ".concat("dark"===b?"bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700":"bg-white dark:bg-dark-200 border-gray-200 dark:border-dark-300"),onClick:()=>k("dark"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("svg",{className:"h-5 w-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"})}),(0,a.jsx)("span",{children:"深色主题"})]})})]})]})]})]})}),(0,a.jsxs)("div",{className:"flex justify-end gap-2 p-4 border-t dark:border-dark-300",children:[(0,a.jsx)(d.Z,{variant:"ghost",onClick:r,children:"取消"}),(0,a.jsx)(d.Z,{variant:"primary",onClick:()=>{o({fontSize:i,lineHeight:h,letterSpacing:m,fontFamily:p,theme:b}),r()},children:"保存"})]})]})}):null}var m=t(3151);function u(e){let{bookId:r,chapterId:t}=e,[n,o]=(0,s.useState)(!1),[i,d]=(0,s.useState)({x:0,y:0}),[c,h]=(0,s.useState)(""),[x,m]=(0,s.useState)(null),u=(0,l.M)(e=>e.setToolbarVisible),[p,g]=(0,s.useState)(!1),[b,k]=(0,s.useState)(!1),[v,f]=(0,s.useState)(null),[y,j]=(0,s.useState)(!1),[w,N]=(0,s.useState)(!1),[C,L]=(0,s.useState)(""),S=(0,s.useRef)(null),[M,I]=(0,s.useState)(!1),[E,z]=(0,s.useState)(!1),W=(0,s.useRef)(null),[B,O]=(0,s.useState)(null);(0,s.useRef)(null),(0,s.useRef)(null),(0,s.useCallback)(e=>{let r;let t=[],a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);for(;r=a.nextNode();){var s;(null===(s=r.textContent)||void 0===s?void 0:s.trim())&&t.push(r)}return t},[]);let H=(0,s.useCallback)((e,r)=>{let t=document.caretRangeFromPoint(e,r);return t?{node:t.startContainer,offset:t.startOffset}:null},[]),R=(0,s.useCallback)((e,r,t,a)=>{let s=document.createRange();s.setStart(e,r),s.setEnd(t,a);let n=window.getSelection();return n?(n.removeAllRanges(),n.addRange(s),n):null},[]),U=(0,s.useCallback)(()=>{let e=window.getSelection();if(!e||e.isCollapsed)return;let r=e.toString().trim();if(!r)return;let t=e.getRangeAt(0).getBoundingClientRect();u(!1),d({x:M?Math.min(Math.max(t.left+t.width/2,150),window.innerWidth-150):t.left+t.width/2,y:M?Math.max(t.top-65,70):t.top-55}),h(r),m(e),o(!0),g(!1),f(null),j(!1),N(!1)},[u,M]),T=(0,s.useCallback)(e=>{let r=document.getElementById("text-selector-toolbar"),t=document.getElementById("translation-tooltip");r&&r.contains(e.target)||t&&t.contains(e.target)||(o(!1),k(!1))},[]),A=(0,s.useCallback)(e=>{if(1!==e.touches.length)return;let r=e.touches[0];H(r.clientX,r.clientY)&&(W.current={x:r.clientX,y:r.clientY,target:e.target},z(!0),O(null))},[H]),F=(0,s.useCallback)(e=>{if(!W.current||!E||1!==e.touches.length)return;let r=e.touches[0],t=H(W.current.x,W.current.y),a=H(r.clientX,r.clientY);t&&a&&R(t.node,t.offset,a.node,a.offset)&&U()},[E,H,R,U]),P=(0,s.useCallback)(e=>{z(!1);let r=document.getElementById("text-selector-toolbar"),t=document.getElementById("translation-tooltip");r&&r.contains(e.target)||t&&t.contains(e.target)||setTimeout(()=>{let r=window.getSelection();r&&!r.isCollapsed&&r.toString().trim()?U():T(e)},100)},[U,T]);(0,s.useEffect)(()=>{let e=()=>{I(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),(0,s.useEffect)(()=>{if(M){let e=document.querySelector('meta[name="viewport"]');e||((e=document.createElement("meta")).setAttribute("name","viewport"),document.head.appendChild(e)),e.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no");let r=e=>{e.touches.length>1&&e.preventDefault()};return document.addEventListener("touchmove",r,{passive:!1}),()=>{document.removeEventListener("touchmove",r),e&&e.setAttribute("content","width=device-width, initial-scale=1.0")}}},[M]),(0,s.useEffect)(()=>{M&&(document.body.style.userSelect="text",document.body.style.webkitUserSelect="text",document.body.style.msUserSelect="text",document.body.style.MozUserSelect="text");let e=e=>{let r=document.getElementById("text-selector-toolbar"),t=document.getElementById("translation-tooltip");r&&r.contains(e.target)||t&&t.contains(e.target)||setTimeout(()=>{let r=window.getSelection();r&&!r.isCollapsed&&r.toString().trim()?U():T(e)},10)};return(document.addEventListener("mouseup",e),document.addEventListener("mousedown",T),M)?(document.addEventListener("touchstart",A,{passive:!0}),document.addEventListener("touchmove",F,{passive:!0}),document.addEventListener("touchend",P),()=>{document.removeEventListener("mouseup",e),document.removeEventListener("mousedown",T),document.removeEventListener("touchstart",A),document.removeEventListener("touchmove",F),document.removeEventListener("touchend",P),document.body.style.userSelect="",document.body.style.webkitUserSelect="",document.body.style.msUserSelect="",document.body.style.MozUserSelect=""}):()=>{document.removeEventListener("mouseup",e),document.removeEventListener("mousedown",T)}},[U,T,M,E,A,F,P]);let V=e=>{if(!x)return;let a=x.getRangeAt(0),s=document.createElement("span");s.className="highlight-".concat(e),s.dataset.bookId=r,s.dataset.chapterId=t,s.dataset.style=e,a.surroundContents(s);let n=JSON.parse(localStorage.getItem("highlights-".concat(r,"-").concat(t))||"[]");n.push({text:c,style:e,timestamp:new Date().toISOString()}),localStorage.setItem("highlights-".concat(r,"-").concat(t),JSON.stringify(n)),M||o(!1)},D=e=>{e.stopPropagation(),(null==v?void 0:v.speakUrl)&&(S.current?S.current.src=v.speakUrl:S.current=new Audio(v.speakUrl),S.current.play().catch(e=>{console.error("播放音频失败:",e)}))},Z=e=>{e.stopPropagation(),(null==v?void 0:v.tSpeakUrl)&&(S.current?S.current.src=v.tSpeakUrl:S.current=new Audio(v.tSpeakUrl),S.current.play().catch(e=>{console.error("播放音频失败:",e)}))},Q=async e=>{if(null==e||e.stopPropagation(),y)return;j(!0),N(!1);let r=e?c:C;e?g(!0):k(!0);try{let e=await fetch("/api/translate?text=".concat(encodeURIComponent(r),"&type=text"));if(!e.ok)throw Error("翻译请求失败");let t=await e.json();if("0"===t.errorCode)f(t);else throw Error(t.message||"翻译失败")}catch(e){console.error("翻译出错:",e),N(!0)}finally{j(!1)}},_=(0,s.useCallback)(()=>{g(!1),k(!1),o(!1),u(!1)},[u]);return n||p||b?(0,a.jsxs)(a.Fragment,{children:[n&&(0,a.jsx)("div",{id:"text-selector-toolbar",className:"fixed z-[60] transform -translate-x-1/2",style:{left:i.x,top:i.y},children:(0,a.jsxs)("div",{className:"bg-white/90 dark:bg-[#1a1a1a]/95 backdrop-blur-md rounded-full shadow-lg border border-gray-200 dark:border-gray-800 flex items-center h-12 px-2 ".concat(M?"flex-wrap gap-1 justify-center w-[calc(100vw-32px)] max-w-md":""),children:[(0,a.jsxs)("button",{className:"flex flex-col items-center justify-center ".concat(M?"w-14":"w-16"," h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group"),onClick:()=>{navigator.clipboard.writeText(c),M||o(!1)},"aria-label":"复制文本",children:[(0,a.jsx)("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"})}),(0,a.jsx)("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"复制"})]}),(0,a.jsxs)("button",{className:"flex flex-col items-center justify-center ".concat(M?"w-14":"w-16"," h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group"),onClick:()=>V("background"),"aria-label":"马克笔高亮",children:[(0,a.jsx)("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),(0,a.jsx)("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"马克笔"})]}),(0,a.jsxs)("button",{className:"flex flex-col items-center justify-center ".concat(M?"w-14":"w-16"," h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group"),onClick:()=>V("wave"),"aria-label":"波浪线高亮",children:[(0,a.jsx)("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),(0,a.jsx)("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"波浪线"})]}),(0,a.jsxs)("button",{className:"flex flex-col items-center justify-center ".concat(M?"w-14":"w-16"," h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group"),onClick:()=>V("underline"),"aria-label":"直线高亮",children:[(0,a.jsx)("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 12h16M4 18h16"})}),(0,a.jsx)("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"直线"})]}),(0,a.jsxs)("button",{className:"flex flex-col items-center justify-center ".concat(M?"w-14":"w-16"," h-12 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#252525] rounded-full transition-colors group"),onClick:Q,"aria-label":"翻译文本",children:[(0,a.jsx)("svg",{className:"w-5 h-5 mb-0.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"})}),(0,a.jsx)("span",{className:"text-[10px] text-gray-600 dark:text-gray-400",children:"翻译"})]})]})}),p&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 z-[9998] bg-black/30",onClick:_,style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.3)"}}),(0,a.jsx)("div",{id:"translation-tooltip",className:"fixed z-[9999] bg-white dark:bg-[#1a1a1a] shadow-xl rounded-lg border dark:border-gray-800 p-4 w-[calc(100vw-32px)] max-w-sm",style:{position:"fixed",left:"50%",top:"50%",transform:"translate(-50%, -50%)",maxHeight:"70vh",overflowY:"auto"},onClick:e=>e.stopPropagation(),children:(0,a.jsx)("div",{className:"space-y-2",children:y?(0,a.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"})}):v?(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2",children:[(0,a.jsx)("div",{className:"break-words max-w-[calc(100%-60px)]",children:c}),(null==v?void 0:v.speakUrl)&&(0,a.jsx)("button",{onClick:D,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放原文发音",children:(0,a.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]}),(0,a.jsx)("div",{className:"border-b border-gray-200 dark:border-gray-800 mb-2"}),(0,a.jsx)("div",{children:v.basic?(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-lg mb-1 dark:text-white",children:v.basic.phonetic&&"[".concat(v.basic.phonetic,"]")}),(0,a.jsx)("div",{className:"space-y-1",children:v.basic.explains.map((e,r)=>(0,a.jsx)("div",{className:"text-sm dark:text-gray-300",children:e},r))})]}):(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("div",{className:"text-sm dark:text-gray-300 break-words max-w-[calc(100%-60px)]",children:v.translation&&v.translation.length>0&&(0,a.jsx)("span",{children:v.translation[0]})}),v.tSpeakUrl&&(0,a.jsx)("button",{onClick:Z,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放翻译发音",children:(0,a.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]})})]}):null})})]}),b&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"fixed inset-0 z-[9998] bg-black/30",onClick:()=>k(!1),style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.3)"}}),(0,a.jsx)("div",{id:"word-translation-tooltip",className:"fixed z-[9999] bg-white dark:bg-[#1a1a1a] shadow-xl rounded-lg border dark:border-gray-800 p-4 w-[calc(100vw-32px)] max-w-sm",style:{position:"fixed",left:"50%",top:"50%",transform:"translate(-50%, -50%)",maxHeight:"70vh",overflowY:"auto"},onClick:e=>e.stopPropagation(),children:(0,a.jsx)("div",{className:"space-y-2",children:y?(0,a.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"})}):v?(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400 mb-2",children:[(0,a.jsx)("div",{className:"break-words max-w-[calc(100%-60px)]",children:C}),(null==v?void 0:v.speakUrl)&&(0,a.jsx)("button",{onClick:D,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放原文发音",children:(0,a.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]}),(0,a.jsx)("div",{className:"border-b border-gray-200 dark:border-gray-800 mb-2"}),(0,a.jsx)("div",{children:v.basic?(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium text-lg mb-1 dark:text-white",children:v.basic.phonetic&&"[".concat(v.basic.phonetic,"]")}),(0,a.jsx)("div",{className:"space-y-1",children:v.basic.explains.map((e,r)=>(0,a.jsx)("div",{className:"text-sm dark:text-gray-300",children:e},r))})]}):(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("div",{className:"text-sm dark:text-gray-300 break-words max-w-[calc(100%-60px)]",children:v.translation&&v.translation.length>0&&(0,a.jsx)("span",{children:v.translation[0]})}),v.tSpeakUrl&&(0,a.jsx)("button",{onClick:Z,className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 ml-5 flex-shrink-0","aria-label":"播放翻译发音",children:(0,a.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]})})]}):null})})]})]}):null}var p=e=>{let{onPrevChapter:r,onNextChapter:t,onOpenChapterList:n,onOpenSettings:o,hasPrevChapter:l,hasNextChapter:i,currentChapter:d,totalChapters:c}=e,[h,x]=(0,s.useState)(!0),[m,u]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{let e=()=>{u(window.innerWidth<768),window.innerWidth<768&&x(!1)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),(0,a.jsx)("div",{className:"fixed left-0 top-1/2 transform -translate-y-1/2 z-30",children:(0,a.jsxs)("nav",{className:"".concat(h?"bg-white/90 dark:bg-[#1a1a1a]/95":"bg-[#1b1b1b]"," rounded-r-lg px-2 py-4 shadow-lg border border-gray-200 dark:border-gray-800 backdrop-blur-md flex flex-col items-center space-y-6 transition-all duration-300 ").concat(h?"".concat("w-16"," opacity-100"):"w-3 opacity-90"),children:[(0,a.jsx)("button",{onClick:()=>{x(!h)},className:"absolute right-0 top-1/2 transform -translate-y-1/2 h-16 w-3 bg-[#1b1b1b] rounded-r transition-all duration-300 flex items-center justify-center","aria-label":h?"收起导航":"展开导航",children:(0,a.jsx)("div",{className:"w-1 h-8 bg-gray-400/50 rounded-full transition-all duration-300 ".concat(h?"opacity-100":"opacity-70")})}),h&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"relative group",children:(0,a.jsxs)("button",{className:"p-2 rounded-full ".concat(l?"hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer":"opacity-50 cursor-not-allowed"," transition-all duration-300 text-gray-700 dark:text-gray-300"),onClick:r,disabled:!l,"aria-label":"上一章",children:[(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:(0,a.jsx)("polyline",{points:"15 18 9 12 15 6"})}),!m&&(0,a.jsx)("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["上一章",(0,a.jsx)("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:(0,a.jsx)("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),(0,a.jsx)("div",{className:"relative group",children:(0,a.jsxs)("button",{className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer transition-all duration-300 text-gray-700 dark:text-gray-300",onClick:n,"aria-label":"章节目录",children:[(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("line",{x1:"8",y1:"6",x2:"21",y2:"6"}),(0,a.jsx)("line",{x1:"8",y1:"12",x2:"21",y2:"12"}),(0,a.jsx)("line",{x1:"8",y1:"18",x2:"21",y2:"18"}),(0,a.jsx)("line",{x1:"3",y1:"6",x2:"3.01",y2:"6"}),(0,a.jsx)("line",{x1:"3",y1:"12",x2:"3.01",y2:"12"}),(0,a.jsx)("line",{x1:"3",y1:"18",x2:"3.01",y2:"18"})]}),!m&&(0,a.jsx)("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["章节目录",(0,a.jsx)("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:(0,a.jsx)("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),(0,a.jsx)("div",{className:"relative group",children:(0,a.jsxs)("button",{className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer transition-all duration-300 text-gray-700 dark:text-gray-300",onClick:o,"aria-label":"设置",children:[(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("circle",{cx:12,cy:12,r:3}),(0,a.jsx)("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]}),!m&&(0,a.jsx)("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["设置",(0,a.jsx)("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:(0,a.jsx)("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),(0,a.jsx)("div",{className:"relative group",children:(0,a.jsxs)("button",{className:"p-2 rounded-full ".concat(i?"hover:bg-gray-100 dark:hover:bg-gray-800/50 cursor-pointer":"opacity-50 cursor-not-allowed"," transition-all duration-300 text-gray-700 dark:text-gray-300"),onClick:t,disabled:!i,"aria-label":"下一章",children:[(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",children:(0,a.jsx)("polyline",{points:"9 18 15 12 9 6"})}),!m&&(0,a.jsx)("div",{className:"absolute invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-300 left-full ml-2 top-1/2 transform -translate-y-1/2 z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-[#1a1a1a] text-gray-800 dark:text-gray-200 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap font-light tracking-wider shadow-lg border border-gray-200 dark:border-gray-800",children:["下一章",(0,a.jsx)("div",{className:"absolute top-1/2 left-0 transform -translate-x-1 -translate-y-1/2",children:(0,a.jsx)("div",{className:"border-4 border-transparent border-r-white dark:border-r-[#1a1a1a]"})})]})})]})}),(0,a.jsxs)("div",{className:"bg-gray-100 dark:bg-[#1a1a1a] rounded-full px-2 py-1 text-xs text-gray-700 dark:text-gray-300 border border-transparent dark:border-gray-800",children:[d,"/",c]})]})]})})};function g(e){let{word:r}=e,[t,n]=(0,s.useState)(null),[o,l]=(0,s.useState)(!1),[i,d]=(0,s.useState)(!1),[c,h]=(0,s.useState)(!1),x=(0,s.useRef)(null),m=(0,s.useRef)(null),u=(0,s.useRef)(null),[p,g]=(0,s.useState)(!1);(0,s.useEffect)(()=>{let e=()=>{g(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]);let b=async()=>{if(!t){l(!0),d(!1);try{let e=await fetch("/api/translate?text=".concat(encodeURIComponent(r),"&type=word"));if(!e.ok)throw Error("翻译请求失败");let t=await e.json();if("0"===t.errorCode)n(t);else throw Error(t.message||"翻译失败")}catch(e){console.error("翻译出错:",e),d(!0)}finally{l(!1)}}},k=(()=>{if(!m.current)return{top:0,left:0};let e=m.current.getBoundingClientRect();if(p){let r=Math.min(Math.max(e.left+e.width/2,150),window.innerWidth-150);return{top:Math.max(e.top-10,50),left:r}}return{top:e.top-10,left:e.left+e.width/2}})();return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{ref:m,className:"cursor-pointer hover:bg-primary-100 dark:hover:bg-primary-900/20 px-0.5 rounded transition-colors inline-block",onClick:e=>{e.stopPropagation(),h(!c),c||t||o||b()},children:r}),c&&(0,a.jsx)("div",{ref:x,className:"fixed z-[100] transform -translate-x-1/2 pointer-events-auto",style:{top:"".concat(k.top-40,"px"),left:"".concat(k.left,"px"),maxWidth:p?"calc(100vw - 40px)":"300px"},children:(0,a.jsx)("div",{className:"bg-white dark:bg-[#1a1a1a] rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 p-3 w-full",children:(0,a.jsxs)("div",{className:"relative",children:[o?(0,a.jsxs)("div",{className:"flex items-center justify-center py-2",children:[(0,a.jsx)("div",{className:"w-5 h-5 border-2 border-t-transparent border-primary-500 rounded-full animate-spin"}),(0,a.jsx)("span",{className:"ml-2 text-sm",children:"翻译中..."})]}):i?(0,a.jsx)("div",{className:"text-sm text-red-500",children:"翻译失败，请重试"}):t?(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)("div",{className:"text-sm font-bold dark:text-gray-200 break-words max-w-[85%]",children:t.query}),t.speakUrl&&(0,a.jsx)("button",{onClick:()=>{(null==t?void 0:t.speakUrl)&&(u.current?u.current.src=t.speakUrl:u.current=new Audio(t.speakUrl),u.current.play().catch(e=>{console.error("播放音频失败:",e)}))},className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 flex-shrink-0","aria-label":"播放原文发音",children:(0,a.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsx)("div",{className:"text-xs dark:text-gray-300 break-words max-w-[85%]",children:t.translation&&t.translation.length>0&&(0,a.jsx)("span",{children:t.translation[0]})}),t.tSpeakUrl&&(0,a.jsx)("button",{onClick:()=>{(null==t?void 0:t.tSpeakUrl)&&(u.current?u.current.src=t.tSpeakUrl:u.current=new Audio(t.tSpeakUrl),u.current.play().catch(e=>{console.error("播放音频失败:",e)}))},className:"text-primary-500 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300 flex-shrink-0","aria-label":"播放翻译发音",children:(0,a.jsx)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})})})]})]}):(0,a.jsx)("div",{className:"text-sm dark:text-gray-300",children:"正在加载翻译..."}),!p&&(0,a.jsx)("div",{className:"absolute left-1/2 bottom-0 transform -translate-x-1/2 translate-y-full",children:(0,a.jsx)("div",{className:"border-8 border-transparent border-t-white dark:border-t-[#1a1a1a]"})})]})})})]})}function b(e){let{bookId:r,initialChapterId:t}=e,d=(0,o.useRouter)(),b=(0,s.useRef)(null),k=(0,s.useRef)(0),v=(0,l.M)(e=>e.settings),f=(0,l.M)(e=>e.isToolbarVisible),y=(0,l.M)(e=>e.setToolbarVisible),j=(0,l.M)(e=>e.setSettingsDialogVisible),w=(0,l.M)(e=>e.setChapterListVisible),N=(0,l.M)(e=>e.readingProgress[r]),C=(0,l.M)(e=>e.updateReadingProgress),L=(0,l.M)(e=>e.aiSettings),[S,M]=(0,s.useState)(t),[I,E]=(0,s.useState)(t),[z,W]=(0,s.useState)(!1),[B,O]=(0,s.useState)(0),[H,R]=(0,s.useState)(!1);(0,s.useEffect)(()=>{document.documentElement.classList.toggle("dark","dark"===v.theme)},[v.theme]);let{data:U}=(0,n.useQuery)(["book",r],()=>(0,i.F3)(r),{enabled:!!r,staleTime:1/0}),{data:T}=(0,n.useQuery)(["chaptersWithLexile",r],()=>(0,i.p0)(r),{enabled:!!r,staleTime:6e4}),{data:A}=(0,n.useQuery)(["chapters",r],()=>(0,i.lc)(r),{enabled:!!r&&!T,staleTime:1/0}),{data:F,isLoading:P,error:V,refetch:D}=(0,n.useQuery)(["chapter",I,L.enabled],async()=>{if(console.log("开始加载目标章节:",I),!I)throw Error("无效的章节ID");try{let e=await (0,i.xQ)(I,L.enabled,L.enabled?L.lexileScore:void 0,L.priorityWords.length>0?L.priorityWords.join(","):void 0);return console.log("章节加载成功:",e.chapterName),M(I),e}catch(e){throw console.error("章节加载失败:",e),e}},{enabled:!!I,retry:2,staleTime:0,cacheTime:0,refetchOnWindowFocus:!1,onSuccess:e=>{console.log("章节内容已更新:",e.chapterName),b.current&&(b.current.scrollTop=0),O(0),R(!1),console.log("章节加载成功，再次确认更新阅读进度:",e.chapterId),C({bookId:r,chapterId:e.chapterId,pageIndex:0,percentage:0,lastRead:new Date().toISOString()})},onError:e=>{console.error("加载章节失败:",e),R(!1)}}),Z=(0,s.useCallback)(async e=>{if(console.log("准备切换到章节:",e),e===I){console.log("已经是目标章节，无需切换");return}try{E(e),console.log("立即更新阅读进度，章节ID:",e),C({bookId:r,chapterId:e,pageIndex:0,percentage:0,lastRead:new Date().toISOString()}),window.history.replaceState({chapterId:e},"","/books/".concat(r,"?chapter=").concat(e)),console.log("目标章节已更新，等待加载新内容")}catch(e){console.error("切换章节失败:",e)}},[r,I,C]);(0,s.useEffect)(()=>{let e=new URLSearchParams(window.location.search).get("chapter");e&&e!==I&&E(e)},[I]),(0,s.useEffect)(()=>{console.log("当前阅读进度状态:",{bookId:r,readingProgress:N,currentChapterId:S,targetChapterId:I,storeState:l.M.getState().readingProgress})},[r,N,S,I]),(0,s.useEffect)(()=>{(null==F?void 0:F.chapterContent)&&b.current&&(b.current.scrollTop=0)},[F]);let Q=(0,s.useCallback)(()=>{if(!(null==A?void 0:A.content)||!F)return;let e=[...A.content].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}),r=e.findIndex(e=>e.chapterId===F.chapterId);if(r>0){let t=e[r-1];console.log("切换到上一章:",t.chapterName),Z(t.chapterId)}},[A,F,Z]),_=(0,s.useCallback)(()=>{if(!(null==A?void 0:A.content)||!F)return;let e=[...A.content].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}),r=e.findIndex(e=>e.chapterId===F.chapterId);if(r<e.length-1){let t=e[r+1];console.log("切换到下一章:",t.chapterName),Z(t.chapterId)}},[A,F,Z]),Y=(0,s.useCallback)(()=>{if(!b.current)return;let{scrollTop:e,scrollHeight:r,clientHeight:t}=b.current;O(Math.min(Math.max(e/(r-t),0),1)),e>k.current+50?(y(!1),k.current=e):e<k.current-50&&(y(!0),k.current=e)},[y]);(0,s.useEffect)(()=>{let e=b.current;if(e)return e.addEventListener("scroll",Y),()=>{e.removeEventListener("scroll",Y)}},[Y]),(0,s.useEffect)(()=>{U&&F&&B>0&&C({bookId:r,chapterId:F.chapterId,pageIndex:0,percentage:B,lastRead:new Date().toISOString()})},[U,F,B,r,C]),(0,s.useEffect)(()=>{if(b.current&&N&&F&&N.chapterId===F.chapterId){let{scrollHeight:e,clientHeight:r}=b.current,t=N.percentage*(e-r);b.current.scrollTop=t,k.current=t}},[F,N]),(0,s.useEffect)(()=>{if(b.current&&F)try{let e=JSON.parse(localStorage.getItem("highlights-".concat(r,"-").concat(F.chapterId))||"[]");b.current.querySelectorAll("[data-book-id]").forEach(e=>{let r=e.parentNode;r&&r.replaceChild(document.createTextNode(e.textContent||""),e)});let t=b.current.textContent||"";e.forEach(e=>{let a=t.indexOf(e.text);if(-1!==a){let t=document.createRange(),s=b.current.firstChild;if(s){t.setStart(s,a),t.setEnd(s,a+e.text.length);let n=document.createElement("span");n.className="highlight-".concat(e.style),n.dataset.bookId=r,n.dataset.chapterId=F.chapterId,n.dataset.style=e.style,t.surroundContents(n)}}})}catch(e){console.error("恢复高亮失败:",e)}},[r,F]);let X=(0,s.useCallback)(()=>{y(!f)},[f,y]),q=(0,s.useCallback)(()=>{W(!0)},[]);if(!U||!A)return(0,a.jsx)("div",{className:"flex items-center justify-center h-screen",children:"加载中..."});if(P)return(0,a.jsx)("div",{className:"flex items-center justify-center h-screen",children:"正在加载章节内容..."});if(V)return(0,a.jsxs)("div",{className:"flex items-center justify-center h-screen flex-col",children:[(0,a.jsx)("div",{className:"text-red-500 mb-4",children:"加载章节内容失败"}),(0,a.jsx)("button",{className:"px-4 py-2 bg-primary-500 text-white rounded-md",onClick:()=>D(),children:"重试"})]});if(!F)return(0,a.jsxs)("div",{className:"flex items-center justify-center h-screen flex-col",children:[(0,a.jsx)("div",{className:"text-red-500 mb-4",children:"章节不存在"}),A.content.length>0&&(0,a.jsx)("button",{className:"px-4 py-2 bg-primary-500 text-white rounded-md",onClick:()=>Z(A.content[0].chapterId),children:"加载第一章"})]});let J=(null==F?void 0:F.chapterContent)?F.chapterContent.split("\n").filter(Boolean).map((e,r)=>{let t;let s=/\b([a-zA-Z]+)\b/g,n=0,o=[];for(;null!==(t=s.exec(e));)t.index>n&&o.push(e.substring(n,t.index)),o.push((0,a.jsx)(g,{word:t[0]},"".concat(r,"-").concat(t.index))),n=t.index+t[0].length;return n<e.length&&o.push(e.substring(n)),(0,a.jsx)("p",{className:"mb-4",children:o},r)}):[],G=(null==A?void 0:A.content)?[...A.content].sort((e,r)=>{if(void 0!==e.chapterOrder&&void 0!==r.chapterOrder)return e.chapterOrder-r.chapterOrder;let t=e.chapterName.match(/(\d+)/),a=r.chapterName.match(/(\d+)/);return t&&a?parseInt(t[1])-parseInt(a[1]):e.chapterName.localeCompare(r.chapterName)}):[],K=G.findIndex(e=>e.chapterId===(null==F?void 0:F.chapterId)),$=K>0,ee=K<G.length-1,er=G.length;return(0,a.jsxs)("div",{className:"relative h-screen bg-white dark:bg-dark-100 flex flex-col",children:[(0,a.jsx)(c,{title:"".concat((null==U?void 0:U.bookName)||""," - ").concat((null==F?void 0:F.chapterName)||""),onBack:()=>d.back(),onOpenChapterList:()=>w(!0),onOpenSettings:()=>j(!0),onToggleAI:q}),(0,a.jsx)("div",{ref:b,className:"flex-1 overflow-y-auto px-4 md:px-0",onClick:X,children:(0,a.jsxs)("div",{className:"max-w-3xl mx-auto py-8",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold mb-6 text-center",children:null==F?void 0:F.chapterName}),(0,a.jsx)("div",{className:"reader-content",style:{fontSize:"".concat(v.fontSize,"px"),fontFamily:v.fontFamily,lineHeight:v.lineHeight,letterSpacing:"".concat(v.letterSpacing,"px")},children:J.length>0?J:(0,a.jsx)("div",{className:"text-center py-12 text-gray-500",children:"章节内容为空"})}),(0,a.jsxs)("div",{className:"mt-12 pt-6 border-t dark:border-dark-300 flex flex-col items-center",children:[(0,a.jsxs)("div",{className:"flex space-x-4 justify-center",children:[$&&(0,a.jsx)("button",{className:"px-6 py-3 bg-primary-100 text-primary-800 dark:bg-primary-900/20 dark:text-primary-100 rounded-md hover:bg-primary-200 dark:hover:bg-primary-900/30 transition-colors",onClick:Q,children:"上一章"}),ee&&(0,a.jsx)("button",{className:"px-6 py-3 bg-primary-500 text-white rounded-md hover:bg-primary-600 transition-colors",onClick:_,children:"下一章"})]}),(0,a.jsx)("button",{className:"mt-4 text-primary-500 dark:text-primary-400 hover:underline",onClick:()=>w(!0),children:"查看目录"})]})]})}),(0,a.jsx)(p,{onPrevChapter:Q,onNextChapter:_,onOpenChapterList:()=>w(!0),onOpenSettings:()=>j(!0),hasPrevChapter:$,hasNextChapter:ee,currentChapter:K+1,totalChapters:er}),(0,a.jsx)(u,{bookId:r,chapterId:(null==F?void 0:F.chapterId)||""}),(0,a.jsx)(h,{chapters:(null==T?void 0:T.content)||(null==A?void 0:A.content)||[],currentChapterId:S,onChapterSelect:Z,onClose:()=>w(!1)}),(0,a.jsx)(x,{onClose:()=>j(!1)}),(0,a.jsx)(m.Z,{isOpen:z,enabled:L.enabled,onEnableChange:e=>{l.M.getState().updateAISettings({...L,enabled:e})},onClose:()=>W(!1)})]})}function k(){var e;let r=(0,o.useParams)(),t=null==r?void 0:r.id;if(!t)return(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsx)("div",{className:"text-lg text-red-500",children:"无效的书籍ID"})});console.log("书籍ID:",t);let d=(0,l.M)(e=>e.readingProgress[t]),{data:c,isLoading:h,error:x}=(0,n.useQuery)(["book",t],()=>(0,i.F3)(t),{enabled:!!t,retry:1,onError:e=>console.error("获取书籍详情失败:",e)}),{data:m,isLoading:u,error:p}=(0,n.useQuery)(["chapters",t],()=>(0,i.lc)(t),{enabled:!!t,retry:1,onError:e=>console.error("获取章节列表失败:",e)});if((0,s.useEffect)(()=>{let e=l.M.getState().settings.theme;document.documentElement.classList.toggle("dark","dark"===e)},[]),h||u)return(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsx)("div",{className:"text-lg",children:"加载中..."})});if(x||p)return(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsx)("div",{className:"text-lg text-red-500",children:x?"加载书籍失败":"加载章节列表失败"})});if(!c||!m||0===m.content.length)return(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsx)("div",{className:"text-lg text-red-500",children:c?"该书籍暂无章节":"书籍不存在"})});console.log("书籍信息:",c),console.log("章节列表:",m.content);let g=(null==d?void 0:d.chapterId)||(null===(e=m.content[0])||void 0===e?void 0:e.chapterId);return(console.log("初始章节ID:",g),g)?(0,a.jsx)(b,{bookId:t,initialChapterId:g}):(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsx)("div",{className:"text-lg text-red-500",children:"无法确定初始章节"})})}}},function(e){e.O(0,[230,21,79,971,69,744],function(){return e(e.s=123)}),_N_E=e.O()}]);